{% extends "base.html" %}

{% block title %}Prescriptive Analytics - What Should We Do?{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-lightbulb me-2"></i>Prescriptive Analytics
            <small class="text-muted">What Should We Do?</small>
        </h1>
    </div>
</div>

<!-- Executive Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-star me-2"></i>Executive Summary & ROI Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h3 class="text-success">${{ "{:,.0f}".format(results.roi_analysis.total_summary.total_investment) }}</h3>
                            <p class="mb-0">Total Investment</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h3 class="text-primary">${{ "{:,.0f}".format(results.roi_analysis.total_summary.total_return) }}</h3>
                            <p class="mb-0">Expected Return</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h3 class="text-warning">{{ "{:.1f}x".format(results.roi_analysis.total_summary.overall_roi + 1) }}</h3>
                            <p class="mb-0">Overall ROI</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h3 class="text-info">{{ "{:.1f}".format(results.roi_analysis.total_summary.payback_period_months) }}</h3>
                            <p class="mb-0">Payback (Months)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Plan -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>Immediate Actions (High Priority)
                </h5>
            </div>
            <div class="card-body">
                {% for action in results.action_plan.immediate_actions %}
                <div class="action-item mb-3 p-3 border border-danger rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="text-danger mb-2">{{ action.action }}</h6>
                            <p class="mb-1"><strong>Timeline:</strong> {{ action.timeline }}</p>
                            <p class="mb-1"><strong>Budget:</strong> ${{ "{:,}".format(action.budget) }}</p>
                            <p class="mb-1"><strong>Expected Impact:</strong> {{ action.expected_impact }}</p>
                            <small class="text-muted">
                                <strong>Success Metrics:</strong> {{ ", ".join(action.success_metrics) }}
                            </small>
                        </div>
                        <span class="badge bg-danger">{{ action.priority }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Medium-Term Actions
                </h5>
            </div>
            <div class="card-body">
                {% for action in results.action_plan.medium_term_actions %}
                <div class="action-item mb-3 p-3 border border-warning rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="text-warning mb-2">{{ action.action }}</h6>
                            <p class="mb-1"><strong>Timeline:</strong> {{ action.timeline }}</p>
                            <p class="mb-1"><strong>Budget:</strong> ${{ "{:,}".format(action.budget) }}</p>
                            <p class="mb-1"><strong>Expected Impact:</strong> {{ action.expected_impact }}</p>
                            <small class="text-muted">
                                <strong>Success Metrics:</strong> {{ ", ".join(action.success_metrics) }}
                            </small>
                        </div>
                        <span class="badge bg-warning">{{ action.priority }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Customer Retention Optimization -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Customer Retention Optimization
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="stat-item">
                            <h4 class="text-danger">{{ results.retention_optimization.high_risk_customers.count }}</h4>
                            <p class="mb-0">High-Risk Customers</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <h4 class="text-warning">{{ "{:.1%}".format(results.retention_optimization.high_risk_customers.avg_churn_probability) }}</h4>
                            <p class="mb-0">Avg Churn Risk</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <h4 class="text-primary">${{ "{:,.0f}".format(results.retention_optimization.high_risk_customers.total_value_at_risk) }}</h4>
                            <p class="mb-0">Value at Risk</p>
                        </div>
                    </div>
                </div>
                
                {% if results.retention_optimization.recommended_strategy %}
                <div class="alert alert-success">
                    <h6><i class="fas fa-trophy me-2"></i>Recommended Retention Strategy</h6>
                    <p class="mb-1"><strong>Campaign Cost:</strong> ${{ results.retention_optimization.recommended_strategy.campaign_cost_per_customer }}/customer</p>
                    <p class="mb-1"><strong>Expected Lift:</strong> {{ results.retention_optimization.recommended_strategy.retention_lift }}</p>
                    <p class="mb-1"><strong>Customers Saved:</strong> {{ results.retention_optimization.recommended_strategy.customers_saved }}</p>
                    <p class="mb-0"><strong>ROI:</strong> {{ "{:.1f}%".format(results.retention_optimization.recommended_strategy.roi_percentage) }}</p>
                </div>
                {% endif %}
                
                <h6>Tactical Recommendations</h6>
                <ul class="list-unstyled">
                    {% for recommendation in results.retention_optimization.tactical_recommendations %}
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>{{ recommendation }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Retention Scenarios
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Cost</th>
                                <th>Lift</th>
                                <th>ROI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for scenario in results.retention_optimization.retention_scenarios %}
                            <tr>
                                <td>${{ scenario.campaign_cost_per_customer }}</td>
                                <td>{{ scenario.retention_lift }}</td>
                                <td class="{{ 'text-success' if scenario.roi_percentage > 100 else 'text-warning' if scenario.roi_percentage > 50 else 'text-danger' }}">
                                    {{ "{:.0f}%".format(scenario.roi_percentage) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Marketing & Pricing Optimization -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>Marketing Campaign Optimization
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <div class="stat-item">
                            <h4 class="text-primary">${{ "{:,}".format(results.marketing_optimization.budget_allocation.total_budget) }}</h4>
                            <p class="mb-0">Total Budget</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <h4 class="text-success">${{ "{:,}".format(results.marketing_optimization.budget_allocation.expected_total_roi) }}</h4>
                            <p class="mb-0">Expected ROI</p>
                        </div>
                    </div>
                </div>
                
                <h6>Campaign Optimization by Segment</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Segment</th>
                                <th>Customers</th>
                                <th>ROI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for campaign in results.marketing_optimization.campaign_optimization %}
                            <tr>
                                <td>{{ campaign.segment }}</td>
                                <td>{{ campaign.target_customers }}</td>
                                <td class="text-success">{{ "{:.1f}%".format(campaign.roi_percentage) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <h6 class="mt-3">Channel Recommendations</h6>
                <ul class="list-unstyled small">
                    {% for channel, description in results.marketing_optimization.channel_recommendations.items() %}
                    <li class="mb-1">
                        <strong>{{ channel.title() }}:</strong> {{ description }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tags me-2"></i>Pricing & Inventory Optimization
                </h5>
            </div>
            <div class="card-body">
                <h6>Pricing Strategies</h6>
                {% for strategy_name, strategy in results.pricing_optimization.pricing_strategies.items() %}
                <div class="mb-3 p-2 border rounded">
                    <h6 class="text-primary mb-1">{{ strategy_name }}</h6>
                    <p class="mb-1"><strong>Strategy:</strong> {{ strategy.strategy }}</p>
                    <p class="mb-1"><strong>Price Change:</strong> {{ strategy.price_change }}</p>
                    <small class="text-muted">{{ strategy.rationale }}</small>
                </div>
                {% endfor %}
                
                <h6 class="mt-3">Optimization Opportunities</h6>
                <ul class="list-unstyled small">
                    {% for opportunity in results.pricing_optimization.optimization_opportunities %}
                    <li class="mb-1">
                        <i class="fas fa-arrow-up text-success me-2"></i>{{ opportunity }}
                    </li>
                    {% endfor %}
                </ul>
                
                <h6 class="mt-3">Inventory Strategies</h6>
                <ul class="list-unstyled small">
                    {% for strategy in results.inventory_optimization.inventory_strategies %}
                    <li class="mb-1">
                        <i class="fas fa-box text-info me-2"></i>{{ strategy }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Resource Allocation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Optimal Resource Allocation
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h4 class="text-primary">${{ "{:,}".format(results.resource_allocation.budget_summary.total_budget) }}</h4>
                            <p class="mb-0">Available Budget</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h4 class="text-success">${{ "{:,}".format(results.resource_allocation.budget_summary.allocated_budget) }}</h4>
                            <p class="mb-0">Allocated Budget</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h4 class="text-info">${{ "{:,}".format(results.resource_allocation.budget_summary.expected_return) }}</h4>
                            <p class="mb-0">Expected Return</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <h4 class="text-warning">{{ "{:.1f}x".format(results.resource_allocation.budget_summary.portfolio_roi) }}</h4>
                            <p class="mb-0">Portfolio ROI</p>
                        </div>
                    </div>
                </div>
                
                <h6>Recommended Allocation</h6>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Initiative</th>
                                <th>Investment</th>
                                <th>Expected ROI</th>
                                <th>Timeline</th>
                                <th>Risk Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for initiative in results.resource_allocation.recommended_allocation %}
                            <tr>
                                <td>{{ initiative.initiative }}</td>
                                <td>${{ "{:,}".format(initiative.required_investment) }}</td>
                                <td class="text-success">{{ "{:.1f}x".format(initiative.expected_roi) }}</td>
                                <td>{{ initiative.implementation_time_months }} months</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if initiative.risk_level == 'Low' else 'warning' if initiative.risk_level == 'Medium' else 'danger' }}">
                                        {{ initiative.risk_level }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <h6 class="mt-3">Resource Priorities</h6>
                <ul class="list-unstyled">
                    {% for priority in results.resource_allocation.resource_priorities %}
                    <li class="mb-2">
                        <i class="fas fa-star text-warning me-2"></i>{{ priority }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Success KPIs -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-target me-2"></i>Success KPIs & Monitoring
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for kpi in results.action_plan.success_kpis %}
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="kpi-item p-3 border rounded">
                            <i class="fas fa-chart-line text-info me-2"></i>
                            <strong>{{ kpi }}</strong>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ROI Comparison Chart
    if ({{ results.charts | length }} > 0) {
        const roiData = {{ results.charts.roi_comparison | safe }};
        const roiChart = {
            x: roiData.x,
            y: roiData.y.map(val => val * 100), // Convert to percentage
            type: 'bar',
            marker: {
                color: roiData.y.map(val => val > 1 ? '#28a745' : val > 0.5 ? '#ffc107' : '#dc3545')
            }
        };
        
        Plotly.newPlot('roiChart', [roiChart], {
            title: 'ROI by Initiative (%)',
            xaxis: {title: 'Initiative'},
            yaxis: {title: 'ROI (%)'},
            margin: {t: 40, r: 40, b: 80, l: 60}
        });
    }
});

// Add interactivity to action items
document.querySelectorAll('.action-item').forEach(item => {
    item.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.02)';
        this.style.transition = 'transform 0.2s ease';
    });
    item.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
});
</script>
{% endblock %}